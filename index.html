<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ¦çˆ¸çˆ¸çš„é‹å‹•è¿½è¹¤å™¨</title>
    <!-- Tailwind CSS è®“ UI æ¨£å¼æ›´ç¾è§€ï¼Œæ”¯æ´éŸ¿æ‡‰å¼è¨­è¨ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        video {
            -webkit-transform: scaleX(-1);
            transform: scaleX(-1);
        }
    </style>
</head>
<body class="bg-gray-800 text-gray-100 flex flex-col items-center justify-center min-h-screen p-4 md:p-8">

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
    <div id="app" class="bg-gray-700 p-6 md:p-10 rounded-3xl shadow-2xl max-w-sm md:max-w-md w-full text-center space-y-6">
        <h1 class="text-3xl md:text-4xl font-bold mb-2 md:mb-4">çµ¦çˆ¸çˆ¸çš„é‹å‹•æŒ‘æˆ°</h1>
        <p id="status" class="text-gray-300 text-lg">é»æ“Šé–‹å§‹ä»¥è¼‰å…¥æ¨¡å‹...</p>

        <!-- å½±ç‰‡ç•«é¢èˆ‡é€²åº¦é¡¯ç¤ºå€å¡Š -->
        <div id="video-container" class="flex flex-col items-center space-y-4">
            <video id="webcam-video" class="w-full max-w-xs md:max-w-sm rounded-xl border-4 border-gray-500 transition-all duration-500 opacity-0 h-0" autoplay playsinline></video>
            <div id="progress-container" class="w-full">
                <div class="bg-gray-600 rounded-full h-4 overflow-hidden mb-2">
                    <div id="progress-bar" class="bg-green-500 h-full transition-all duration-500" style="width: 0%;"></div>
                </div>
                <p class="text-lg font-semibold">
                    å·²é‹å‹•æ™‚é–“ï¼š<span id="exercise-time" class="text-green-400">00:00</span> / 30:00
                </p>
                <p id="movement-status" class="text-sm text-gray-400 mt-1">ç‹€æ…‹ï¼š</p>
            </div>
        </div>

        <!-- æŒ‰éˆ•å€å¡Š -->
        <div id="button-container">
            <button id="start-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105" disabled>
                æ­£åœ¨è¼‰å…¥...
            </button>
        </div>
        
        <!-- æŒ‘æˆ°å®Œæˆè¨Šæ¯ -->
        <div id="completion-message" class="bg-green-700 text-white p-6 rounded-xl shadow-md mt-6 hidden">
            <p class="text-2xl font-bold">æŒ‘æˆ°å®Œæˆï¼ğŸ‰</p>
            <p class="mt-2 text-sm">å¯†ç¢¼å·²ç™¼é€è‡³é›»è…¦ã€‚</p>
        </div>
    </div>

    <!-- Firebase å’Œ TensorFlow.js å‡½å¼åº« -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.13.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/movenet@1.0.0/dist/movenet.min.js"></script>

    <!-- æ ¸å¿ƒ JavaScript é‚è¼¯ -->
    <script>
        // å…¨å±€è®Šæ•¸
        const MIN_EXERCISE_TIME = 30 * 60;
        let model;
        let exerciseTime = 0;
        let isMoving = false;
        let isWebcamActive = false;
        let isChallengeComplete = false;
        let intervalRef;
        let animationFrameRef;
        let db, auth, userId;
        
        // DOM å…ƒç´ 
        const startButton = document.getElementById('start-button');
        const webcamVideo = document.getElementById('webcam-video');
        const statusElement = document.getElementById('status');
        const exerciseTimeElement = document.getElementById('exercise-time');
        const movementStatusElement = document.getElementById('movement-status');
        const progressBar = document.getElementById('progress-bar');
        const completionMessage = document.getElementById('completion-message');

        // åˆå§‹åŒ– Firebase
        const initializeFirebase = async () => {
            try {
                // å®‰å…¨åœ°ä½¿ç”¨ç’°å¢ƒè®Šæ•¸
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                await auth.signInAnonymously();
                userId = auth.currentUser.uid;
            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–éŒ¯èª¤:", error);
            }
        };

        // è¼‰å…¥ TensorFlow.js æ¨¡å‹
        const loadModel = async () => {
            statusElement.textContent = "æ­£åœ¨è¼‰å…¥æ¨¡å‹ï¼Œè«‹ç¨å€™...";
            try {
                model = await movenet.load("https://tfhub.dev/google/movenet/singlepose/lightning/4");
                statusElement.textContent = "æ¨¡å‹è¼‰å…¥å®Œæˆï¼è«‹é»æ“Šé–‹å§‹ã€‚";
                startButton.disabled = false;
                startButton.textContent = "é–‹å§‹æŒ‘æˆ°";
            } catch (error) {
                statusElement.textContent = "è¼‰å…¥æ¨¡å‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚";
                console.error("è¼‰å…¥æ¨¡å‹å¤±æ•—:", error);
            }
        };

        // å•Ÿå‹•æ”åƒé ­
        const startWebcam = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                webcamVideo.srcObject = stream;
                await webcamVideo.play();
                statusElement.textContent = "è«‹é–‹å§‹é‹å‹•ï¼";
                isWebcamActive = true;
                webcamVideo.classList.remove('opacity-0', 'h-0');
                webcamVideo.classList.add('opacity-100');
                runPoseDetection();
                startTimer();
            } catch (err) {
                statusElement.textContent = "ç„¡æ³•å–å¾—æ”åƒé ­æ¬Šé™ã€‚";
                console.error("æ”åƒé ­æ¬Šé™éŒ¯èª¤:", err);
            }
        };

        // å§¿å‹¢åµæ¸¬è¿´åœˆ
        const runPoseDetection = async () => {
            if (isWebcamActive && webcamVideo.readyState === 4) {
                const keypoints = await model.estimateSinglePose(webcamVideo);
                const moving = detectMovement(keypoints);
                isMoving = moving;
                movementStatusElement.textContent = `ç‹€æ…‹ï¼š${isMoving ? "æ­£åœ¨é‹å‹•ä¸­ ğŸ’ª" : "è«‹é–‹å§‹å‹•ä¸€å‹•ï¼"}`;
            }
            animationFrameRef = requestAnimationFrame(runPoseDetection);
        };

        // åµæ¸¬ç§»å‹•
        const detectMovement = (keypoints) => {
            const keypointThreshold = 0.5;
            const visibleKeypoints = keypoints.keypoints.filter(kp => kp.score > keypointThreshold);
            return visibleKeypoints.length > 5;
        };

        // è¨ˆæ™‚å™¨
        const startTimer = () => {
            if (!intervalRef) {
                intervalRef = setInterval(() => {
                    if (isMoving && exerciseTime < MIN_EXERCISE_TIME) {
                        exerciseTime++;
                        updateUI();
                    }
                    if (exerciseTime >= MIN_EXERCISE_TIME && !isChallengeComplete) {
                        completeChallenge();
                    }
                }, 1000);
            }
        };

        // æ›´æ–° UI
        const updateUI = () => {
            const minutes = Math.floor(exerciseTime / 60);
            const seconds = exerciseTime % 60;
            exerciseTimeElement.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            progressBar.style.width = `${(exerciseTime / MIN_EXERCISE_TIME) * 100}%`;
        };

        // å®ŒæˆæŒ‘æˆ°
        const completeChallenge = async () => {
            isChallengeComplete = true;
            isWebcamActive = false;
            if (intervalRef) clearInterval(intervalRef);
            if (animationFrameRef) cancelAnimationFrame(animationFrameRef);
            
            webcamVideo.srcObject.getTracks().forEach(track => track.stop());
            webcamVideo.classList.remove('opacity-100');
            webcamVideo.classList.add('opacity-0', 'h-0');

            const writeData = async () => {
                if (db && userId) {
                    const password = Math.random().toString(36).substring(2, 10);
                    const docRef = db.collection('artifacts').doc('default-app-id').collection('users').doc(userId).collection('challenges').doc();
                    await docRef.set({
                        completed: true,
                        time_seconds: exerciseTime,
                        password: password,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    document.getElementById('video-container').style.display = 'none';
                    document.getElementById('button-container').style.display = 'none';
                    completionMessage.classList.remove('hidden');
                }
            };
            await writeData();
        };

        startButton.addEventListener('click', startWebcam);
        
        // ç¢ºä¿ç¨‹å¼ç¢¼åœ¨å‡½å¼åº«è¼‰å…¥å¾Œç«‹å³åŸ·è¡Œ
        initializeFirebase().then(() => {
            loadModel();
        });
    </script>
</body>
</html>